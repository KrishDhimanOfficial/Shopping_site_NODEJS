<!DOCTYPE html>
<html lang="en">
<!-- Header Section Begin -->
<%- include('../site_partials/header') %>

    <!-- Header Section End -->

    <!-- breadcumb begin -->
    <div class="breadcrumb-option">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="breadcrumb__links">
                        <a href="/home"><i class="fa fa-home"></i> Home</a>
                        <span>Shop</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Shop Section Begin -->
    <section class="shop spad">
        <div class="container">
            <div class="row">
                <%- include('../site_partials/product_filters') %>
                    <div class="col-lg-9 col-md-9">
                        <div class="row">
                            <% if (locals.products) { %>
                                <% const productArray=products.collectionData[0]?.product; %>
                                    <% productArray?.forEach(product=> { %>
                                        <div class="col-lg-4 col-md-6">
                                            <div class="product__item">
                                                <div class="product__item__pic set-bg"
                                                    data-setbg="/uploads/<%= product.product_image[0] %>">
                                                    <% if (product.product_new==true) { %>
                                                        <div class="label new">
                                                            New
                                                        </div>
                                                        <% } %>
                                                            <% if(product.product_on_sales==true) {%>
                                                                <div class="label sale">Sale</div>
                                                                <% }%>
                                                                    <ul class="product__hover">
                                                                        <li>
                                                                            <a href="/uploads/<%= product.product_image[0] %>"
                                                                                class="image-popup">
                                                                                <span class="arrow_expand"></span>
                                                                            </a>
                                                                        </li>
                                                                        <li>
                                                                            <button>
                                                                                <span
                                                                                    class="icon_heart_alt like"></span>
                                                                            </button>
                                                                        </li>
                                                                        <li>
                                                                            <button class="cart"
                                                                                data-id="<%= product._id %>">
                                                                                <span class="icon_bag_alt"></span>
                                                                            </button>
                                                                        </li>
                                                                    </ul>
                                                </div>
                                                <div class="product__item__text">
                                                    <h6><a href="/product/<%= product._id%>">
                                                            <%= product.product_title %>
                                                        </a></h6>
                                                    <div class="rating">
                                                        <i class="fa fa-star"></i>
                                                        <i class="fa fa-star"></i>
                                                        <i class="fa fa-star"></i>
                                                        <i class="fa fa-star"></i>
                                                        <i class="fa fa-star"></i>
                                                    </div>
                                                    <div class="product__price">$<%= product.product_discount %>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <% }) %>
                                            <% } %>
                                                <!-- show All product -->
                                                <% if (locals.allProducts) { %>
                                                    <% allProducts.collectionData.forEach(product=> { %>
                                                        <div class="col-lg-4 col-md-6">
                                                            <div class="product__item">
                                                                <div class="product__item__pic set-bg"
                                                                    data-setbg="/uploads/<%= product.product_image[0] %>">
                                                                    <% if (product.product_new==true) { %>
                                                                        <div class="label new"> New</div>
                                                                        <% } %>
                                                                            <% if(product.product_on_sales==true) {%>
                                                                                <div class="label sale"> Sale</div>
                                                                                <% }%>
                                                                                    <ul class="product__hover">
                                                                                        <li>
                                                                                            <a href="/uploads/<%= product.product_image[0] %>"
                                                                                                class="image-popup">
                                                                                                <span
                                                                                                    class="arrow_expand"></span>
                                                                                            </a>
                                                                                        </li>
                                                                                        <li>
                                                                                            <button>
                                                                                                <span
                                                                                                    class="icon_heart_alt like"></span>
                                                                                            </button>
                                                                                        </li>
                                                                                        <li>
                                                                                            <button class="cart"
                                                                                                data-id="<%= product._id %>">
                                                                                                <span
                                                                                                    class="icon_bag_alt"></span>
                                                                                            </button>
                                                                                        </li>
                                                                                    </ul>
                                                                </div>
                                                                <div class="product__item__text">
                                                                    <h6>
                                                                        <a href="/product/<%= product._id%>">
                                                                            <%= product.product_title %>
                                                                        </a>
                                                                    </h6>
                                                                    <div class="rating">
                                                                        <i class="fa fa-star"></i>
                                                                        <i class="fa fa-star"></i>
                                                                        <i class="fa fa-star"></i>
                                                                        <i class="fa fa-star"></i>
                                                                        <i class="fa fa-star"></i>
                                                                    </div>
                                                                    <div class="product__price">
                                                                        $ <%= product.product_discount %>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <% }) %>
                                                            <% } %>
                                                                <!-- Show sub_category_products -->
                                                                <% if (locals.sub_category_products) { %>
                                                                    <% sub_category_products.collectionData?.forEach(product=> { %>
                                                                        <div class="col-lg-4 col-md-6">
                                                                            <div class="product__item">
                                                                                <div class="product__item__pic set-bg"
                                                                                    data-setbg="/uploads/<%= product.product_image[0] %>">
                                                                                    <% if (product.product_new==true) {
                                                                                        %>
                                                                                        <div class="label new"> New
                                                                                        </div>
                                                                                        <% } %>
                                                                                            <% if(product.product_on_sales==true){
                                                                                                %>
                                                                                                <div class="label sale">
                                                                                                    Sale
                                                                                                </div>
                                                                                                <% }%>
                                                                                                    <ul
                                                                                                        class="product__hover">
                                                                                                        <li>
                                                                                                            <a href="/uploads/<%= product.product_image[0] %>"
                                                                                                                class="image-popup">
                                                                                                                <span
                                                                                                                    class="arrow_expand"></span>
                                                                                                            </a>
                                                                                                        </li>
                                                                                                        <li>
                                                                                                            <button>
                                                                                                                <span
                                                                                                                    class="icon_heart_alt like"></span>
                                                                                                            </button>
                                                                                                        </li>
                                                                                                        <li>
                                                                                                            <button
                                                                                                                class="cart"
                                                                                                                data-id="<%= product._id %>">
                                                                                                                <span
                                                                                                                    class="icon_bag_alt"></span>
                                                                                                            </button>
                                                                                                        </li>
                                                                                                    </ul>
                                                                                </div>
                                                                                <div class="product__item__text">
                                                                                    <h6>
                                                                                        <a
                                                                                            href="/product/<%= product._id%>">
                                                                                            <%= product.product_title %>
                                                                                        </a>
                                                                                    </h6>
                                                                                    <div class="rating">
                                                                                        <i class="fa fa-star"></i>
                                                                                        <i class="fa fa-star"></i>
                                                                                        <i class="fa fa-star"></i>
                                                                                        <i class="fa fa-star"></i>
                                                                                        <i class="fa fa-star"></i>
                                                                                    </div>
                                                                                    <div class="product__price">
                                                                                        $ <%= product.product_discount
                                                                                            %>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <% }) %>
                                                                            <% } %>
                                                                            <div class="col-lg-12 text-center">
                                                                                    <div class="pagination__option">
                                                                                        <% if (locals.products) { %>
                                                                                            <% if (products.totalDocs>  products.limit) { %>
                                                                                                <% for( let i=1;  i<=products.totalPages; ++i ) { %>
                                                                                                    <a
                                                                                                        href="page/<%= i  %>">
                                                                                                        <%= i %>
                                                                                                    </a>
                                                                                                <% } %>
                                                                                            <% } %>
                                                                                        <% } %>

                                                                                        <!-- show All product pagination-->
                                                                                        <% if(locals.allProducts){  %>
                                                                                            <% if  (allProducts.totalDocs>  allProducts.limit) { %>
                                                                                                <% for( let i=1; i<=allProducts.totalPages; ++i) { %>
                                                                                                    <a
                                                                                                        href="/shop/<%= i  %>">
                                                                                                        <%= i %>
                                                                                                    </a>
                                                                                                <% } %>
                                                                                            <% } %>
                                                                                        <% } %>
                                                                                        <!-- show sub_category_products pagination -->
                                                                                        <% if (locals.sub_category_products) { %>
                                                                                            <% if(sub_category_products.totalDocs> sub_category_products.limit){ %>
                                                                                                <% for( let i=1; i<=sub_category_products.totalPages; ++i){%>
                                                                                                    <a
                                                                                                        href="<%= i  %>">
                                                                                                        <%= i  %>
                                                                                                    </a>
                                                                                                <% } %>
                                                                                            <% } %>
                                                                                        <% } %>
                                                                                    </div>
                                                                                </div>
                        </div>
                    </div>
            </div>
        </div>
    </section>
    <!-- Shop Section End -->
    <!-- Instagram Begin -->
    <%- include('../site_partials/social_links') %>
        <!-- Instagram End -->

        <!-- Footer Section Begin -->
        <%- include('../site_partials/footer') %>
            <!-- Footer Section End -->

            <!-- Search Begin -->
            <div class="search-model">
                <div class="h-100 d-flex align-items-center justify-content-center">
                    <div class="search-close-switch">+</div>
                    <form class="search-model-form">
                        <input type="text" id="search-input" placeholder="Search here.....">
                    </form>
                </div>
            </div>
            <!-- Search End -->
            <%- include('../site_partials/script') %>
                <script>
                    const cartbtn = document.querySelectorAll('.cart');
                    cartbtn.forEach(btn => {
                        btn.addEventListener('click', async () => {
                            const productId = btn.dataset.id;
                            await fetch('http://localhost:8000/addtocart', {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    product_cart: { product_details: { pid: productId } }
                                })
                            })
                        })
                    })

                    const priceFilter = document.querySelector('#priceFilter')
                    const sizeFilter = document.querySelectorAll('.product_size')
                    const colorFilter = document.querySelectorAll('.colorfilter')
                    const minamount = document.querySelector('#minamount')
                    const maxamount = document.querySelector('#maxamount')

                    let sizeArray = []
                    let colorArray = []
                    sizeFilter.forEach(filter => {
                        filter.addEventListener('change', () => {
                            if (!filter.checked) {
                                sizeArray = [...new Set(sizeArray)]
                            } else {
                                const size = filter.getAttribute('id')
                                sizeArray.push(size)
                            }
                            fetchFilterData(minamount.value, maxamount.value, sizeArray, colorArray)
                        })
                    })
                    colorFilter.forEach(filter => {
                        filter.addEventListener('change', () => {
                            const color = filter.getAttribute('id')
                            if (!filter.checked) {
                                colorArray = [...new Set(colorArray)]
                            } else {
                                colorArray.push(color)
                                fetchFilterData(minamount.value, maxamount.value, sizeArray, colorArray)
                            }
                        })
                    })

                    priceFilter.addEventListener('click', async (e) => {
                        e.preventDefault()
                        await fetch('http://localhost:8000/filter/price', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                minamount: parseInt(minamount.value),
                                maxamount: parseInt(maxamount.value)
                            })
                        })
                            .then(response => response.json())
                            .then(data => console.log(data))
                    })

                    async function fetchFilterData(minamount, maxamount, sizeArray, colorArray) {
                        await fetch(`http://localhost:8000/filter`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ minamount, maxamount, sizeArray, colorArray })
                        })
                            .then(response => response.json())
                            .then(data => console.log(data))

                    } 
                </script>
                </body>

</html>