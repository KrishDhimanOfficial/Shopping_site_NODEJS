<!DOCTYPE html>
<html lang="en">
<!-- Header Section Begin -->
<%- include('../site_partials/header') %>

    <!-- Header Section End -->
    <!-- breadcumb begin -->
    <div class="breadcrumb-option">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="breadcrumb__links">
                        <a href="/home"><i class="fa fa-home"></i> Home</a>
                        <span>
                            checkout
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Checkout Section Begin -->
    <section class="checkout spad">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <h6 class="coupon__link"><span class="icon_tag_alt"></span> <a href="#">Have a coupon?</a> Click
                        here to enter your code.</h6>
                </div>
            </div>
            <form class="checkout__form">
                <div class="row">
                    <div class="col-lg-8">
                        <h5>Billing detail</h5>
                        <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-6">
                                <div class="checkout__form__input">
                                    <p>First Name <span>*</span></p>
                                    <input type="text" id="first_name">
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-6">
                                <div class="checkout__form__input">
                                    <p>Last Name <span>*</span></p>
                                    <input type="text" id="last_name">
                                </div>
                            </div>
                            <div class="col-lg-12">
                                <div class="checkout__form__input">
                                    <p>Country <span>*</span></p>
                                    <input type="text" id="country">
                                </div>
                                <div class="checkout__form__input">
                                    <p>Address <span>*</span></p>
                                    <input type="text" placeholder="Street Address" id="street_address">
                                    <input type="text" placeholder="Apartment. suite, unite ect ( optinal )"
                                        id="address">
                                </div>
                                <div class="checkout__form__input">
                                    <p>Town/City <span>*</span></p>
                                    <input type="text" id="city">
                                </div>
                                <div class="checkout__form__input">
                                    <p>Country/State <span>*</span></p>
                                    <input type="text" id="state">
                                </div>
                                <div class="checkout__form__input">
                                    <p>Postcode/Zip <span>*</span></p>
                                    <input type="text" id="pincode">
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-6">
                                <div class="checkout__form__input">
                                    <p>Phone <span>*</span></p>
                                    <input type="text" id="phone_no">
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-6">
                                <div class="checkout__form__input">
                                    <p>Email <span>*</span></p>
                                    <input type="email" id="email">
                                </div>
                            </div>
                            <div class="col-lg-12">
                                <div class="checkout__form__checkbox">
                                    <label for="acc">
                                        Create an acount?
                                        <input type="checkbox" id="acc">
                                        <span class="checkmark"></span>
                                    </label>
                                    <p>Create am acount by entering the information below. If you are a returing
                                        customer login at the <br />top of the page</p>
                                </div>
                                <div class="checkout__form__checkbox">
                                    <label for="note" class="pl-0">
                                        Note about your order, e.g, special noe for delivery
                                    </label>
                                </div>
                                <div class="checkout__form__input">
                                    <p>Oder notes <span>*</span></p>
                                    <input type="text" id="order_note"
                                        placeholder="Note about your order, e.g, special noe for delivery">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="checkout__order">
                            <h5>Your order</h5>
                            <div class="checkout__order__product">
                                <ul>
                                    <li>
                                        <span class="top__text">Product</span>
                                        <span class="top__text__right">Total</span>
                                    </li>
                                    <% if (locals.products) { %>
                                        <input type="text" hidden id="userObjId" value="<%= userDetails[0]._id %>">
                                        <% } %>
                                            <% for( let i=0; i < products.product_cart.length; ++i ) { %>
                                                <% const obj=products.product_cart[i].product_details %>
                                                    <% const product_name=products.cartproduct[i].product_title %>
                                                        <% const pid=products.cartproduct[i]._id %>
                                                            <% const
                                                                quantity=products.product_cart[i].product_details.quantity
                                                                %>
                                                                <li> 0
                                                                    <%= i + 1 %>.
                                                                        <%= product_name %>
                                                                            <span>$ <%= obj.total %> </span>
                                                                            <input type="number" class="p_quantity"
                                                                                value="<%= quantity %>" hidden>
                                                                            <input type="text" class="pid"
                                                                                value="<%= pid %>" hidden>
                                                                </li>
                                                                <% } %>
                                </ul>
                            </div>
                            <div class="checkout__order__total">
                                <ul>
                                    <li>Subtotal
                                        <span>$
                                            <% if (locals.grandTotal) { %>
                                                <%= grandTotal %>
                                                    <% } %>
                                        </span>
                                    </li>
                                    <li>Total
                                        <span>$
                                            <% if (locals.grandTotal) { %>
                                                <%= grandTotal %>
                                                    <input type="number" hidden id="grandtotal"
                                                        value="<%= grandTotal %>">
                                                    <% } %>
                                        </span>
                                    </li>
                                </ul>
                            </div>
                            <div class="checkout__order__widget">
                                <label for="o-acc">
                                    Create an acount?
                                    <input type="checkbox" id="o-acc">
                                    <span class="checkmark"></span>
                                </label>
                                <p>Create am acount by entering the information below. If you are a returing customer
                                    login at the top of the page.</p>
                                <label for="check-payment">
                                    Cheque payment
                                    <input type="checkbox" id="check-payment">
                                    <span class="checkmark"></span>
                                </label>
                                <label for="razorpay">
                                    Razorpay
                                    <input type="checkbox" id="razorpay">
                                    <span class="checkmark"></span>
                                </label>
                            </div>
                            <button type="submit" id="rzp-button1" class="site-btn">Place oder</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>
    <!-- Checkout Section End -->

    <!-- Instagram Begin -->
    <%- include('../site_partials/social_links') %>
        <!-- Instagram End -->

        <!-- Footer Section Begin -->
        <%- include('../site_partials/footer') %>
            <!-- Footer Section End -->

            <!-- Search Begin -->
            <div class="search-model">
                <div class="h-100 d-flex align-items-center justify-content-center">
                    <div class="search-close-switch">+</div>
                    <form class="search-model-form">
                        <input type="text" id="search-input" placeholder="Search here.....">
                    </form>
                </div>
            </div>
            <!-- Search End -->
            <%- include('../site_partials/script') %>
                <script src="https://checkout.razorpay.com/v1/checkout.js" defer></script>
                <script defer>
                    document.querySelector('#rzp-button1').onclick = async (e) => {
                        e.preventDefault()
                        const q_input = document.querySelectorAll('.p_quantity')
                        const pid_input = document.querySelectorAll('.pid')
                        const quantity = q_input.forEach(quantity => quantity.value)

                        const items = []
                        for (let i = 0; i < pid_input.length; ++i) {
                            let obj = {
                                pid: pid_input[i].value,
                                quantity: parseInt(q_input[i].value)
                            }
                            items.push(obj)
                        }
                        const response = await fetch('http://localhost:8000/orders', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', },
                            body: JSON.stringify({
                                amount: parseInt('<%= grandTotal %>') * 100,
                                currency: "USD",
                                receipt: "qwsaq1"
                            })
                        })

                        const order = await response.json()
                        var options = {
                            key: "rzp_test_MJo0dgy1G9lLYA",
                            amount: "<%= grandTotal %>",
                            currency: "USD",
                            id: "Ashion",
                            description: "Test Transaction",
                            image: "/images/logo.png",
                            order_id: `${order.id}`,
                            handler: async (response) => {
                                // Send Details to validate order AND save Entry 
                                await fetch('http://localhost:8000/order/validate', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json', },
                                    body: JSON.stringify({
                                        razorpay_order_id: response.razorpay_order_id,
                                        razorpay_payment_id: response.razorpay_payment_id,
                                        razorpay_signature: response.razorpay_signature,
                                        userId: document.querySelector('#userObjId').value,
                                        order_note: document.querySelector('#order_note').value,
                                        totalAmount: parseInt(document.querySelector('#grandtotal').value),
                                        items: items,
                                        contact: {
                                            first_name: document.querySelector('#first_name').value,
                                            last_name: document.querySelector('#last_name').value,
                                            phone_no: parseInt(document.querySelector('#phone_no').value),
                                            email: document.querySelector('#email').value,
                                        },
                                        shippingAddress: {
                                            main_address: document.querySelector('#street_address').value,
                                            optional_address: document.querySelector('#address').value,
                                            city: document.querySelector('#city').value,
                                            state: document.querySelector('#state').value,
                                            country: document.querySelector('#country').value,
                                            pincode: document.querySelector('#pincode').value,
                                        }
                                    })
                                })
                                    .then(res => res.json())
                                    .then(data => window.location.href = 'http://localhost:8000/account')
                                // Send Email to User 
                                await fetch('http://localhost:8000/send/confirm/order', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json', },
                                    body: JSON.stringify({
                                        email: document.querySelector('#email').value,
                                        razorpay_order_id: response.razorpay_order_id,
                                        razorpay_payment_id: response.razorpay_payment_id,
                                    })
                                })
                            },
                            notes: { address: "Razorpay Corporate Office" },
                            theme: { color: "#3399cc" }
                        }
                        var rzp1 = new window.Razorpay(options);
                        rzp1.on('payment.failed', function (response) {
                            // alert(response.error.code);
                            // alert(response.error.description);
                            // alert(response.error.source);
                            // alert(response.error.step);
                            // alert(response.error.reason);
                            // alert(response.error.metadata.order_id);
                            // alert(response.error.metadata.payment_id);
                        })
                        rzp1.open()
                    }
                </script>
                </body>

</html>